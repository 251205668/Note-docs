<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基础 | 前端面试知识总结</title>
    <meta name="description" content="自家使用,暂不外传">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.6a4803ab.css" as="style"><link rel="preload" href="/assets/js/app.81dd3622.js" as="script"><link rel="preload" href="/assets/js/2.d1b1e148.js" as="script"><link rel="preload" href="/assets/js/27.2938dd4c.js" as="script"><link rel="preload" href="/assets/js/4.a3faee54.js" as="script"><link rel="prefetch" href="/assets/js/10.42124fbe.js"><link rel="prefetch" href="/assets/js/11.bdef2e64.js"><link rel="prefetch" href="/assets/js/12.9c5e83ed.js"><link rel="prefetch" href="/assets/js/13.3db43aaf.js"><link rel="prefetch" href="/assets/js/14.8f2ec86d.js"><link rel="prefetch" href="/assets/js/15.c6286125.js"><link rel="prefetch" href="/assets/js/16.5da2b31d.js"><link rel="prefetch" href="/assets/js/17.c9deef07.js"><link rel="prefetch" href="/assets/js/18.13ed30af.js"><link rel="prefetch" href="/assets/js/19.f1a01180.js"><link rel="prefetch" href="/assets/js/20.30f7288c.js"><link rel="prefetch" href="/assets/js/21.477730e4.js"><link rel="prefetch" href="/assets/js/22.ab119ff1.js"><link rel="prefetch" href="/assets/js/23.9bbc22fc.js"><link rel="prefetch" href="/assets/js/24.cb1899b8.js"><link rel="prefetch" href="/assets/js/25.64669f1d.js"><link rel="prefetch" href="/assets/js/26.f3040183.js"><link rel="prefetch" href="/assets/js/28.cd87026d.js"><link rel="prefetch" href="/assets/js/29.b92287f4.js"><link rel="prefetch" href="/assets/js/3.103e70cb.js"><link rel="prefetch" href="/assets/js/30.af43d48f.js"><link rel="prefetch" href="/assets/js/31.8c7148f5.js"><link rel="prefetch" href="/assets/js/32.d42beb3f.js"><link rel="prefetch" href="/assets/js/33.223bba8e.js"><link rel="prefetch" href="/assets/js/34.04b12083.js"><link rel="prefetch" href="/assets/js/35.19c65fa0.js"><link rel="prefetch" href="/assets/js/36.a1a664b9.js"><link rel="prefetch" href="/assets/js/37.d2e7a2dd.js"><link rel="prefetch" href="/assets/js/38.4f737159.js"><link rel="prefetch" href="/assets/js/39.fcdeadea.js"><link rel="prefetch" href="/assets/js/40.40a9daf9.js"><link rel="prefetch" href="/assets/js/5.2f32d917.js"><link rel="prefetch" href="/assets/js/6.d92ecc16.js"><link rel="prefetch" href="/assets/js/7.a09f8ef2.js"><link rel="prefetch" href="/assets/js/8.5b00daa2.js"><link rel="prefetch" href="/assets/js/9.9d06f44a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6a4803ab.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">前端面试知识总结</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><span class="title">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/project/shop/" class="nav-link">
  大型电商
</a></li><li class="dropdown-item"><!----> <a href="/project/music/" class="nav-link">
  vue实现音乐app
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><span class="title">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/project/shop/" class="nav-link">
  大型电商
</a></li><li class="dropdown-item"><!----> <a href="/project/music/" class="nav-link">
  vue实现音乐app
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>目录</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" class="sidebar-link">项目介绍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>css基础到进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/css/test.html" class="sidebar-link">移动端问题</a></li><li><a href="/guide/css/layout.html" class="sidebar-link">前端常见布局</a></li><li><a href="/guide/css/alwaysCode.html" class="sidebar-link">常用css片段</a></li><li><a href="/guide/css/iconfont.html" class="sidebar-link">全局stylus配置及使用iconfont</a></li><li><a href="/guide/css/css-skill.html" class="sidebar-link">灵活使用css技巧</a></li><li><a href="/guide/css/code.html" class="sidebar-link">code pratice</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>js基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/js/base.html" class="sidebar-link">基础</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>js进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/js/higher.html" class="sidebar-link">js??</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MVVM分析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/vue/vue.html" class="sidebar-link">vue 基础部分</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack实战分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Node.js基础到进阶</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/node/koa.html" class="active sidebar-link">基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/node/koa.html#基础" class="sidebar-link">基础</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#中间件" class="sidebar-link">中间件</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#洋葱模型" class="sidebar-link">洋葱模型</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#async-await" class="sidebar-link">async await</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#路由" class="sidebar-link">路由</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#改造-路由" class="sidebar-link">改造 路由</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#校验处理" class="sidebar-link">校验处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/node/koa.html#获取参数" class="sidebar-link">获取参数</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#异常处理" class="sidebar-link">异常处理</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#参数校验" class="sidebar-link">参数校验</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#sql复习" class="sidebar-link">sql复习</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/node/koa.html#创建数据库" class="sidebar-link">创建数据库</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#删除数据库" class="sidebar-link">删除数据库</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#创建表" class="sidebar-link">创建表</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#删除表" class="sidebar-link">删除表</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#查看表结构" class="sidebar-link">查看表结构</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#修改表结构" class="sidebar-link">修改表结构</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#增" class="sidebar-link">增</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#删" class="sidebar-link">删</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#改" class="sidebar-link">改</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#查" class="sidebar-link">查</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#sequlize-模型导入数据库" class="sidebar-link">sequlize(模型导入数据库)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/node/koa.html#初始化配置" class="sidebar-link">初始化配置</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#sequelize相关api" class="sidebar-link">sequelize相关API</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#注册" class="sidebar-link">注册</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/node/koa.html#编写校验器" class="sidebar-link">编写校验器</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#编写注册api-（标准流程）" class="sidebar-link">编写注册API  （标准流程）</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#明文加密" class="sidebar-link">明文加密</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#登录" class="sidebar-link">登录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/node/koa.html#准备工作" class="sidebar-link">准备工作</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#书写路由" class="sidebar-link">书写路由</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#微信登录接口" class="sidebar-link">微信登录接口</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#颁布令牌-获取token" class="sidebar-link">颁布令牌,获取token</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#路由携带令牌校验" class="sidebar-link">路由携带令牌校验</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#前端携带令牌-basicauth方式-api-key方式" class="sidebar-link">前端携带令牌(BasicAuth方式)  (API key方式)</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#具体业务" class="sidebar-link">具体业务</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#获取最新一期期刊" class="sidebar-link">获取最新一期期刊</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#点赞-取消点赞" class="sidebar-link">点赞 取消点赞</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#上一期-下一期" class="sidebar-link">上一期 下一期</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#获取点赞信息" class="sidebar-link">获取点赞信息</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#获取某一期的详情信息" class="sidebar-link">获取某一期的详情信息</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#获取用户喜欢期刊列表" class="sidebar-link">获取用户喜欢期刊列表</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#获取热门图书" class="sidebar-link">获取热门图书</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#评论" class="sidebar-link">评论</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#json序列化" class="sidebar-link">json序列化</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#koa-static" class="sidebar-link">KOA-STATIC</a></li><li class="sidebar-sub-header"><a href="/guide/node/koa.html#自动无感知刷新令牌" class="sidebar-link">自动无感知刷新令牌</a></li></ul></li><li><a href="/guide/node/springboot.html" class="sidebar-link">Springboot</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>面试题总结</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h2> <p>编写一个接口的最基本代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/classic/latest'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">&quot;classic&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// router.routes() 注册中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http监听端口3000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h2> <p>中间件-发送http调用的函数，一个实例可以定义多个中间件，中间件调用总是返回<code>promise</code></p> <p><code>app.use</code>注册中间件。<code>ctx</code>上下文，<code>next</code>下一个中间件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 中间件--就是函数</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// ctx 上下文</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'七月'</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'八月'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>传递参数
通过挂载到ctx传参,首先要保证洋葱模型</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span>r<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'www.baidu.com'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 打印出dom结构，实现了传参</span>
</code></pre></div><h2 id="洋葱模型"><a href="#洋葱模型" class="header-anchor">#</a> 洋葱模型</h2> <p>先执行fun1上 再执行中间件函数 在执行fun1下。可以判断函数是否完全执行，以中间件函数为分界线
<img src="https://image.yangxiansheng.top/img/QQ%E6%88%AA%E5%9B%BE20200321195714.png?imagelist" alt=""></p> <p>简单的例子:</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">funt1下</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">funt2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>使用async,await强制promise同步调用化，调用顺序
fun1() ====&gt; fun2() ====&gt; fun1下</p> <h2 id="async-await"><a href="#async-await" class="header-anchor">#</a> async await</h2> <p>await特性:</p> <ul><li>求值
await 理解为计算<code>promise</code>的值,使用await使用一定要在function前加上<code>async</code>，也可以对表达式求值。使用async,<strong>await一定可以使中间件保持洋葱模型</strong>。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 1 3 2</span>
</code></pre></div><ul><li>阻塞线程
常见的异步调用:<code>对资源 读文件 操作数据库 发送http</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//默认异步调用</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'www.baidu.com'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          <span class="token keyword">const</span> a <span class="token operator">=</span> res
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 由于是异步请求 打印结果 1 2 res</span>

使用<span class="token keyword">await</span>阻塞线程之后，异步同步化
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'www.baidu.com'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 打印 1 res 2</span>
</code></pre></div><h2 id="路由"><a href="#路由" class="header-anchor">#</a> 路由</h2> <p>初级路由判断 <code>ctx.path</code>返回路由,<code>ctx.method</code>返回调用方法，<code>ctx.body</code>定义返回内容</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path <span class="token operator">===</span><span class="token string">'/clasic/latest'</span> <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>method <span class="token operator">===</span><span class="token string">'GET'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span>  <span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">&quot;clasic&quot;</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>使用<code>koa-router</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>nodemon 自动重启node服务
全局启动<code>nodemon app.js</code></p> <p><strong>一键导入module <code>require-directory</code>轮子</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> requireDirectory <span class="token operator">=</span> <span class="token function">reuire</span><span class="token punctuation">(</span><span class="token string">'require-directory'</span><span class="token punctuation">)</span>

<span class="token function">requreDirectory</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span><span class="token string">'./api/v1'</span><span class="token punctuation">,</span><span class="token function-variable function">visit</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">whenExportModule</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Router</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="改造-路由"><a href="#改造-路由" class="header-anchor">#</a> 改造 路由</h2> <p>创建 core.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Router  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> requireDirectory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'require-dicectory'</span><span class="token punctuation">)</span>

<span class="token comment">// 导入全部模块前判断 是否是Router的对象 </span>
<span class="token keyword">class</span> <span class="token class-name">InitManger</span><span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token function">initcore</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        InitManager<span class="token punctuation">.</span>app <span class="token operator">=</span> app
        InitManager<span class="token punctuation">.</span><span class="token function">InitLoadRouters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token function">InitLoadRouters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/v1</span><span class="token template-punctuation string">`</span></span>
        <span class="token function">requireDirectory</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span>path<span class="token punctuation">,</span><span class="token punctuation">{</span>
            visit<span class="token operator">:</span>whenLoadrouters
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">function</span> <span class="token function">whenLoadrouters</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Router</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              InitManger<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>app.js引入</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> IniManager <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'core.js'</span><span class="token punctuation">)</span>

InitManager<span class="token punctuation">.</span><span class="token function">initcore</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="校验处理"><a href="#校验处理" class="header-anchor">#</a> 校验处理</h2> <h3 id="获取参数"><a href="#获取参数" class="header-anchor">#</a> 获取参数</h3> <p>假设访问的路由地址为<code>localhost:3000/v1/3/classic/latest?password=123</code> header:<code>token:1111</code> ,body:<code>{&quot;key&quot;:&quot;localhost&quot;}</code></p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/v1/:id/classic/latest'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// 获取url参数</span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params
    <span class="token comment">// 获取query </span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query
    <span class="token comment">// 获取token</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header
    <span class="token comment">// 获取访问时内容</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">&quot;classic&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="异常处理"><a href="#异常处理" class="header-anchor">#</a> 异常处理</h3> <p>设置全局返回的状态码   <strong>异常分为：<code>已知异常</code> <code>未知异常</code></strong></p> <div class="language-js extra-class"><pre class="language-js"><code>message
error_code
request_url
<span class="token constant">HTTP</span> status code <span class="token number">2</span>xx <span class="token number">4</span>xx <span class="token number">5</span>xx
常见Http状态码

<span class="token number">200</span> <span class="token string">'ok'</span>
<span class="token number">400</span> <span class="token string">'params error'</span>
<span class="token number">404</span> <span class="token string">'Not found'</span>
<span class="token number">403</span> <span class="token string">'forbidden'</span>
<span class="token number">502</span> <span class="token string">'bad gateway'</span> 路径错误
<span class="token number">500</span> <span class="token string">'服务器异常'</span>
<span class="token number">504</span> <span class="token string">'服务器超时'</span>
</code></pre></div><p><strong>全局异常处理</strong></p> <p>定义一个<code>execption</code>类继承<code>Error</code>,然后抛出异常时实例化，传递参数，打印全局异常返回json</p> <ul><li><p>创建Http-execption.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Httpexecption</span> <span class="token keyword">extends</span> <span class="token class-name">Errror</span><span class="token punctuation">{</span>
   <span class="token comment">// 定义构造函数</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>msg<span class="token operator">=</span><span class="token string">&quot;服务器异常&quot;</span><span class="token punctuation">,</span>code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span>errorCode<span class="token operator">=</span><span class="token number">10001</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> <span class="token number">10001</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Paramexecption</span> <span class="token keyword">extends</span> <span class="token class-name">Httpexecption</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span>code<span class="token punctuation">,</span>errCode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg <span class="token operator">||</span> <span class="token string">'参数错误'</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">400</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> <span class="token number">10000</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    Httpexecption<span class="token punctuation">,</span>
    Paramexecption
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>创建全局异常处理中间件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>Httpexecption<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'Http-execption'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> execption <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">Httpexecption</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
                msg<span class="token operator">:</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">,</span>
                error_code<span class="token operator">:</span>error<span class="token punctuation">.</span>errorCode<span class="token punctuation">,</span>
                request<span class="token operator">:</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports<span class="token operator">=</span>execption  <span class="token comment">// app.js注册该中间件</span>
</code></pre></div></li> <li><p>在定义路由时抛出异常</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>Paramexecption<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'Http-execption'</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/latest'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>query<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Paramexecption</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        thorw error
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>未知异常</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">else</span><span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        msg<span class="token operator">:</span><span class="token string">&quot;未知异常发生&quot;</span><span class="token punctuation">,</span>
        erro_code<span class="token operator">:</span><span class="token number">999</span><span class="token punctuation">,</span>
        request<span class="token operator">:</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">500</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="参数校验"><a href="#参数校验" class="header-anchor">#</a> 参数校验</h3> <p>使用<code>Lin-validator</code>进行参数校验 使用前必须定义好全局抛出参数异常的 <code>Paramexecption</code>,然后引入<code>util.js</code></p> <p><strong>第一步 创建校验器类</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>Linvalidator<span class="token punctuation">,</span>Rule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'Lin-validator.js'</span>

<span class="token comment">// 校验正整数 </span>
<span class="token keyword">class</span> <span class="token class-name">PositiveIntegerValidator</span> <span class="token keyword">extends</span> <span class="token class-name">Linvalidator</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//  使用lin-validator校验规则 三个参数 规则，返回提示信息，附加参数</span>
    <span class="token comment">//  要与路由的参数信息一一对应 数组形式</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token punctuation">[</span> 
      <span class="token keyword">new</span> <span class="token class-name">Rule</span><span class="token punctuation">(</span><span class="token string">'isInt'</span><span class="token punctuation">,</span><span class="token string">'参数必须是正整数'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>min<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>PositiveIntegerValidator<span class="token punctuation">}</span>
</code></pre></div><p><strong>第二步 引用校验器进行校验</strong> (调用validate方法)</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>PositiveIntegerValidator<span class="token punctuation">}</span>  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'validator.js'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/classic/:id/latest'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PositiveIntegerValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>**使用校验器获参数 ** get方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> param <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params
<span class="token keyword">const</span> v <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">PositiveIntegerValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token keyword">const</span> id <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'param.id'</span><span class="token punctuation">)</span>  <span class="token comment">// 自动将id 转换为整形</span>
<span class="token comment">// 如果不想转换  </span>
<span class="token keyword">const</span> id <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'param.id'</span><span class="token punctuation">,</span>parsed<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre></div><h4>配置开发环境的异常抛出</h4>
由于我们捕获到的异常都去做了全局异常处理，导致某些异常无法判断， 所以定义config来配置开发环境
<div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    enviorment<span class="token operator">:</span><span class="token string">&quot;dev&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在全局异常中间件,判断是否是开发环境,然后抛出异常</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>config<span class="token punctuation">.</span>enviorment <span class="token operator">===</span> <span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> error
<span class="token punctuation">}</span>
</code></pre></div><h2 id="sql复习"><a href="#sql复习" class="header-anchor">#</a> sql复习</h2> <h3 id="创建数据库"><a href="#创建数据库" class="header-anchor">#</a> 创建数据库</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> 数据库名
</code></pre></div><h3 id="删除数据库"><a href="#删除数据库" class="header-anchor">#</a> 删除数据库</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">DATABASE</span> 数据库名
</code></pre></div><h3 id="创建表"><a href="#创建表" class="header-anchor">#</a> 创建表</h3> <p>约束</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token number">1.</span> 非空约束  <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token number">2.</span> 默认值约束  <span class="token keyword">DEFAULT</span> <span class="token string">'男'</span>
<span class="token number">3.</span> 唯一性约束 <span class="token keyword">UNIQUE</span>
<span class="token number">3.</span> 主键约束 <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> 表名<span class="token punctuation">(</span>
字段名 类型<span class="token punctuation">(</span>长度<span class="token punctuation">)</span> <span class="token punctuation">[</span>约束<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span>
</code></pre></div><p>常见类型</p> <p><img src="https://image.yangxiansheng.top/img/1585018919602.png?imagelist" alt=""></p> <h3 id="删除表"><a href="#删除表" class="header-anchor">#</a> 删除表</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">;</span>
</code></pre></div><h3 id="查看表结构"><a href="#查看表结构" class="header-anchor">#</a> 查看表结构</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DESC</span> 表名
</code></pre></div><h3 id="修改表结构"><a href="#修改表结构" class="header-anchor">#</a> 修改表结构</h3> <div class="language-sql extra-class"><pre class="language-sql"><code>修改列名
<span class="token keyword">Alter</span> <span class="token keyword">table</span> 表名  change  列名  新列名 类型<span class="token punctuation">;</span>

修改列类型
<span class="token keyword">Alter</span> <span class="token keyword">table</span> 表名  <span class="token keyword">modify</span>  列名  新类型<span class="token punctuation">;</span>
</code></pre></div><h3 id="增"><a href="#增" class="header-anchor">#</a> 增</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> 表名<span class="token punctuation">(</span>字段<span class="token number">1</span>，字段<span class="token number">2.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token keyword">values</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre></div><p>其他方式</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> 表名<span class="token punctuation">(</span>字段<span class="token number">1</span><span class="token punctuation">,</span>字段<span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//插入多条数据【MYSQL】</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> 表名 <span class="token keyword">values</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//针对全表所有字段进行插入操作</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> 表名<span class="token punctuation">(</span>字段<span class="token punctuation">)</span> <span class="token keyword">select</span> 字段 <span class="token keyword">from</span> 表<span class="token number">2</span><span class="token punctuation">;</span>         <span class="token comment">//查询结果插入</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> 表名 <span class="token keyword">select</span> 字段 <span class="token keyword">from</span> 表<span class="token number">2</span><span class="token punctuation">;</span>               <span class="token comment">//查询结果，全表插入</span>
</code></pre></div><h3 id="删"><a href="#删" class="header-anchor">#</a> 删</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> 表 <span class="token keyword">where</span> 条件
</code></pre></div><h3 id="改"><a href="#改" class="header-anchor">#</a> 改</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">update</span> 表 <span class="token keyword">set</span> 字段<span class="token operator">=</span>值 <span class="token keyword">where</span> 条件
例: <span class="token keyword">update</span> <span class="token keyword">user</span> <span class="token keyword">set</span> username<span class="token operator">=</span><span class="token number">7</span>yue <span class="token keyword">where</span> id <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="查"><a href="#查" class="header-anchor">#</a> 查</h3> <p>查询表中全部内容</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名
</code></pre></div><p>查询指定列信息</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> 列<span class="token number">1</span> <span class="token keyword">from</span> 表名
</code></pre></div><p>条件查询</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> 列<span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">from</span> 表名 <span class="token keyword">where</span> 条件
</code></pre></div><p>条件运算符  逻辑运算符</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token operator">=</span>  <span class="token operator">&gt;</span>  <span class="token operator">&gt;=</span>  <span class="token operator">&lt;</span>  <span class="token operator">&lt;=</span>  <span class="token operator">and</span>  <span class="token operator">&amp;&amp;</span>  <span class="token operator">or</span>  <span class="token operator">not</span>
</code></pre></div><p>范围查询</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">where</span> 列 <span class="token operator">between</span> 条件<span class="token number">1</span>  <span class="token operator">and</span> 条件<span class="token number">2</span><span class="token punctuation">;</span>          <span class="token comment">//列在这个区间的值</span>

<span class="token keyword">where</span> 列 <span class="token operator">not</span> <span class="token operator">between</span> 条件<span class="token number">1</span> <span class="token operator">and</span> 条件<span class="token number">2</span><span class="token punctuation">;</span>    <span class="token comment">//不在这个区间</span>

<span class="token keyword">where</span> <span class="token operator">!</span><span class="token punctuation">(</span> 列 <span class="token operator">between</span> 条件<span class="token number">1</span> <span class="token operator">and</span> 条件<span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//同样表示不在这个区间</span>
</code></pre></div><p>空值查询</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">where</span> 列 <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">;</span>  <span class="token comment">//查询列中值为null的数据</span>
</code></pre></div><p>模糊查询</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">where</span> 列 <span class="token operator">like</span> <span class="token string">'%0'</span><span class="token punctuation">;</span>   <span class="token comment">//表示以0结尾</span>
<span class="token keyword">where</span> 列 <span class="token operator">like</span>  <span class="token string">'0%'</span><span class="token punctuation">;</span>   <span class="token comment">//表示以0开头</span>
<span class="token keyword">where</span> 列 <span class="token operator">like</span>  <span class="token string">'%0%'</span><span class="token punctuation">;</span>   <span class="token comment">//表示数据中包含0</span>
</code></pre></div><p>排序</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">where</span> 条件 <span class="token keyword">order</span> <span class="token keyword">by</span> 列 <span class="token punctuation">[</span><span class="token keyword">asc</span><span class="token operator">/</span><span class="token keyword">desc</span><span class="token punctuation">]</span>
</code></pre></div><p>多表查询</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表<span class="token number">1</span><span class="token punctuation">,</span>表<span class="token number">2</span>  <span class="token keyword">where</span> 表<span class="token number">1.</span>字段<span class="token operator">=</span>表<span class="token number">2.</span>字段<span class="token punctuation">;</span>  <span class="token comment">//隐式内连接,使用where条件消除笛卡尔积</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表<span class="token number">1</span> <span class="token punctuation">[</span><span class="token keyword">inner</span><span class="token punctuation">]</span> <span class="token keyword">join</span> 表<span class="token number">2</span> <span class="token keyword">on</span> 表<span class="token number">1.</span>字段<span class="token operator">=</span>表<span class="token number">2.</span>字段<span class="token punctuation">;</span>  <span class="token comment">//显式内连接,如果是多张表，则一直在join..on后依次添加join..on即可,inner关键字可被省略</span>
</code></pre></div><h2 id="sequlize-模型导入数据库"><a href="#sequlize-模型导入数据库" class="header-anchor">#</a> sequlize(模型导入数据库)</h2> <h3 id="初始化配置"><a href="#初始化配置" class="header-anchor">#</a> 初始化配置</h3> <blockquote><p>以上配置都可以参考<a href="https://sequelize.org/v5/index.html" target="_blank" rel="noopener noreferrer">sequelize文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或者<a href="https://itbilu.com/nodejs/npm/V1PExztfb.html" target="_blank" rel="noopener noreferrer">中文文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>第一步，定义数据库配置</p> <p>config.js</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    database<span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token comment">// 数据库名 主机号 端口 用户名 密码</span>
        dbName<span class="token operator">:</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">,</span>
        host<span class="token operator">:</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span>
        port<span class="token operator">:</span><span class="token number">3306</span><span class="token punctuation">,</span>
        user<span class="token operator">:</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span><span class="token string">&quot;wohenpi0918&quot;</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>第二步，配置<code>sequelize</code>  更多配置参考
<a href="https://itbilu.com/nodejs/npm/V1PExztfb.html" target="_blank" rel="noopener noreferrer">API文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Sequelize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>dbName<span class="token punctuation">,</span>host<span class="token punctuation">,</span>port<span class="token punctuation">,</span>user<span class="token punctuation">,</span>password<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'config.js'</span><span class="token punctuation">)</span>

<span class="token comment">// 参数: 数据库名 用户名 密码 配置具体 </span>
<span class="token keyword">const</span> sequlize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span>dbName<span class="token punctuation">,</span>user<span class="token punctuation">,</span>password<span class="token punctuation">.</span><span class="token punctuation">{</span>
 	<span class="token comment">// 数据库类型</span>
      dialect<span class="token operator">:</span><span class="token string">'mysql'</span><span class="token punctuation">,</span>
      host<span class="token punctuation">,</span>
      port<span class="token punctuation">,</span>
    <span class="token comment">// 是否在命令行打印出sql</span>
      logging<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 显示北京时间</span>
  	  timezone<span class="token operator">:</span><span class="token string">'+08:00'</span><span class="token punctuation">,</span>
      define<span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token comment">// 加入创建时间 更新 updatedAt, createdAt</span>
      timestamps<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 必须和timestamps同时使用 增加一个 deletedAt 标识当前时间</span>
      paranoid<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 重命名 时间戳字段</span>
       createdAt<span class="token operator">:</span><span class="token string">'created_at'</span><span class="token punctuation">,</span>
       updatedAt<span class="token operator">:</span><span class="token string">'updated_at'</span><span class="token punctuation">,</span>
       deletedAt<span class="token operator">:</span><span class="token string">'deleted_at'</span><span class="token punctuation">,</span>
    <span class="token comment">// 不使用驼峰式命令规则，这样会在使用下划线分隔</span>
    <span class="token comment">// 这样 updatedAt 的字段名会是 updated_at</span>
       underscored<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      
   <span class="token comment">// 同步模型到数据库中</span>
   sequelize<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
       <span class="token comment">// 是否强制更新 删除后直接覆盖数据表</span>
       force<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>sequelize<span class="token punctuation">}</span>
</code></pre></div><p>第三步,定义模型层</p> <p>model下创建user.js  更多定义方法 参考<a href="https://sequelize.org/v5/manual/data-types.html" target="_blank" rel="noopener noreferrer">数据类型<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>sequelize<span class="token punctuation">}</span> <span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'db.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Sequelize<span class="token punctuation">,</span>Model<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span><span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
<span class="token comment">// 定义模型层</span>
User<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 主键: 不能为空 不能重复</span>
  id<span class="token operator">:</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span>Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
    primaryKey<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 自动增长 id编号</span>
    autoIncrement<span class="token operator">:</span><span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  username<span class="token operator">:</span><span class="token punctuation">{</span>type<span class="token operator">:</span>Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>unique<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span>Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span><span class="token punctuation">{</span>type<span class="token operator">:</span>Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>unique<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  openid<span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token comment">// 最大字符长度 64</span>
    type<span class="token operator">:</span>Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    unique<span class="token operator">:</span><span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
  sequelize<span class="token punctuation">,</span>
   <span class="token comment">// 自定义表名  默认会以模型名为表名</span>
  tableName<span class="token operator">:</span><span class="token string">'user'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>启动项目, sequelize会创建一张<code>user</code>表</p> <p><img src="https://image.yangxiansheng.top/img/1584979877301.png?imagelist" alt=""></p> <h3 id="sequelize相关api"><a href="#sequelize相关api" class="header-anchor">#</a> sequelize相关API</h3> <blockquote><p>sequelize大多数查询的API都是返回的pormise对象,所以定义模型方法时加上 <code>async</code>和<code>await</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token number">1.</span> 定义模型  <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">unit</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>sequelize<span class="token punctuation">,</span>tableName<span class="token operator">:</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token number">2.</span> 访问字段和设置字段值  <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">let</span> title <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataValue</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>  <span class="token keyword">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token number">3.</span> 验证Validations
username<span class="token operator">:</span><span class="token punctuation">{</span>type<span class="token operator">:</span>Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>validate<span class="token operator">:</span><span class="token punctuation">{</span>len<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Model类<span class="token constant">API</span>

<span class="token number">1.</span> <span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token punctuation">[</span>attribute<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">删除一个字段属性</span><span class="token punctuation">(</span>列<span class="token punctuation">)</span>

<span class="token number">2.</span> <span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 将当前模型同步到数据库  可以配置<span class="token punctuation">{</span>force<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span> 强制覆盖<span class="token punctuation">,</span>每次同步都会先删除之前的表

<span class="token number">3.</span> <span class="token function">drop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 删除数据库的表

<span class="token number">4.</span> <span class="token function">getTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 获取表名，可以指定schema

<span class="token number">5.</span> <span class="token function">scope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 定义限制范围

<span class="token number">6.</span> findOne 查询单条数据  <span class="token keyword">await</span> ModelNmae<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    where<span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string">'index'</span><span class="token operator">:</span>value
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token number">7.</span> findAll 查询多条数据  <span class="token keyword">await</span> ModelName<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    where<span class="token operator">:</span><span class="token punctuation">{</span>
        attr1<span class="token operator">:</span>value<span class="token punctuation">,</span>
        attr2<span class="token operator">:</span>value
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>   
这里可以使用到 大于<span class="token punctuation">,</span>小于等<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$gt</span><span class="token template-punctuation string">`</span></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">lte</span><span class="token template-punctuation string">`</span></span>  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$or</span><span class="token template-punctuation string">`</span></span>
Model<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span>
    attr1<span class="token operator">:</span> <span class="token punctuation">{</span>
      $gt<span class="token operator">:</span> <span class="token number">50</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    attr2<span class="token operator">:</span> <span class="token punctuation">{</span>
      $lte<span class="token operator">:</span> <span class="token number">45</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    attr3<span class="token operator">:</span> <span class="token punctuation">{</span>
      $<span class="token keyword">in</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    attr4<span class="token operator">:</span> <span class="token punctuation">{</span>
      $ne<span class="token operator">:</span> <span class="token number">5</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// WHERE attr1 &gt; 50 AND attr2 &lt;= 45 AND attr3 IN (1,2,3) AND attr4 != 5</span>


<span class="token number">8.</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  通过主键id查询单个实例

<span class="token number">9.</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  统计数量

<span class="token number">10.</span> findAndCount  分页查询

<span class="token number">11.</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 创建实例

<span class="token number">12.</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token number">13.</span> upsert 创建或更新

<span class="token number">14.</span> className<span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token operator">...</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>  
 创建事务
 Modle类<span class="token punctuation">.</span><span class="token function">transcation</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">t</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     <span class="token keyword">await</span> Favor<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
         uid<span class="token punctuation">,</span>art_id<span class="token punctuation">,</span>type
     <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>transcation<span class="token operator">:</span>t<span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token operator">...</span>更多操作
 <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token number">15.</span> destory 删除记录

<span class="token number">16.</span> restore 恢复记录

<span class="token number">17</span> 自增自减  increment decrement
user<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'number'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>by<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h2 id="注册"><a href="#注册" class="header-anchor">#</a> 注册</h2> <blockquote><p>首先定义好模型 然后编写校验器 密码用盐加密，处理好异常</p></blockquote> <h3 id="编写校验器"><a href="#编写校验器" class="header-anchor">#</a> 编写校验器</h3> <p>用户名: 用户名长度规范 唯一性规范</p> <p>密码: 正则表达式规范</p> <p>邮箱:  邮箱规范 唯一性规范</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>User<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'user.js'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">RegisterValidator</span> <span class="token keyword">extends</span> <span class="token class-name">Linvalidator</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 用户名</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>username<span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token keyword">new</span> <span class="token class-name">Rule</span><span class="token punctuation">(</span><span class="token string">'isLength'</span><span class="token punctuation">,</span><span class="token string">'用户名不符合规范'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>min<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span>max<span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
        <span class="token comment">// 密码</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>password1 <span class="token operator">=</span>  <span class="token punctuation">[</span>
            <span class="token keyword">new</span> <span class="token class-name">Rule</span><span class="token punctuation">(</span><span class="token string">'matches'</span><span class="token punctuation">,</span><span class="token string">'密码必须包含特殊字符,字母,数字并且超过六位'</span>，<span class="token string">'/^.*(?=.{6,})(?=.*\d)(?=.*[A-Z])(?=.*[a-z])(?=.*[!@#$%^&amp;*? ]).*$/'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
        <span class="token comment">// 校验规则相同</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>password1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password2
        <span class="token keyword">this</span><span class="token punctuation">.</span>email <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token keyword">new</span> <span class="token class-name">Rule</span><span class="token punctuation">(</span><span class="token string">'isEmail'</span><span class="token punctuation">,</span><span class="token string">'邮箱不符合规范'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//自定义方法 校验用户和邮箱的唯一性 必须以validate开头</span>
    <span class="token function">validateUserName</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 通过params.body 拿到body参数</span>
        <span class="token keyword">const</span> username <span class="token operator">=</span> params<span class="token punctuation">.</span>body<span class="token punctuation">.</span>username
        <span class="token comment">// sequelize条件查询</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> User<span class="token punctuation">.</span><span class="token function">finOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            where<span class="token operator">:</span><span class="token punctuation">{</span>
                username<span class="token operator">:</span>username
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">validateEmail</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> email <span class="token operator">=</span> params<span class="token punctuation">.</span>body<span class="token punctuation">.</span>email
        <span class="token keyword">const</span> user <span class="token operator">=</span> USer<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            where<span class="token operator">:</span><span class="token punctuation">{</span>
                email<span class="token operator">:</span>email
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="编写注册api-（标准流程）"><a href="#编写注册api-（标准流程）" class="header-anchor">#</a> 编写注册API  （标准流程）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 添加前缀</span>
    prefix<span class="token operator">:</span><span class="token string">'/v1/user'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// 守门员 校验参数 只有当通过校验器才能插入模型数据</span>
    <span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">RegisterValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token comment">// 获取通过校验的参数</span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
        username<span class="token operator">:</span>v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'body.username'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span>v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'body.password1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        email<span class="token operator">:</span>v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'body.email'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 插入数据库  模型.create(参数列表)</span>
	<span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h3 id="明文加密"><a href="#明文加密" class="header-anchor">#</a> 明文加密</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bcryptjs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcryptjs'</span><span class="token punctuation">)</span>
<span class="token comment">//定义密码模型时加密</span>
User<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    password<span class="token operator">:</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span>Sequeize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        <span class="token keyword">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 取盐 赋盐</span>
            <span class="token keyword">const</span> sault <span class="token operator">=</span> bcryptjs<span class="token punctuation">.</span><span class="token function">getSaltSync</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token keyword">const</span> pwd <span class="token operator">=</span> bcryptjs<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span>sault<span class="token punctuation">)</span>
            <span class="token comment">// 将盐赋值</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span>pwd<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="登录"><a href="#登录" class="header-anchor">#</a> 登录</h2> <blockquote><p>定义好登陆的方式 然后编写相关的校验器，</p></blockquote> <h3 id="准备工作"><a href="#准备工作" class="header-anchor">#</a> 准备工作</h3> <p>首先定义好登录的方式 ,模仿枚举方式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定义一个判断方法 ,判断是否在这几个类型中</span>
<span class="token keyword">function</span> <span class="token function">isInType</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> LoginType <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//  邮箱 手机号 小程序登录</span>
    <span class="token constant">USER_EMAIL</span><span class="token operator">:</span><span class="token number">100</span><span class="token punctuation">,</span>
    <span class="token constant">USER_PHONE</span><span class="token operator">:</span><span class="token number">101</span><span class="token punctuation">,</span>
    <span class="token constant">USER_MINI</span><span class="token operator">:</span><span class="token number">102</span><span class="token punctuation">,</span>
    isInType
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    LoginType
<span class="token punctuation">}</span>
</code></pre></div><p>正式编写路由 （三个步骤）</p> <ul><li>编写校验器</li> <li>校验传入的参数的账号密码是否存在数据库</li> <li>返回响应</li></ul> <p><strong>对<code>account</code>和<code>secret</code>进行校验,然后校验登录方式合法</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>

<span class="token keyword">class</span> <span class="token class-name">Loginvalidator</span> <span class="token keyword">extends</span> <span class="token class-name">Linvalidator</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>account <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token keyword">new</span> <span class="token class-name">Rule</span><span class="token punctuation">(</span><span class="token string">'isLength'</span><span class="token punctuation">,</span><span class="token string">&quot;账号不符合规范&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>min<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span>max<span class="token operator">:</span><span class="token number">128</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>secret <span class="token operator">=</span> <span class="token punctuation">[</span>
          <span class="token keyword">new</span> <span class="token class-name">Rule</span> <span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'isOptional'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token keyword">new</span> <span class="token class-name">Rule</span><span class="token punctuation">(</span><span class="token string">'isLength'</span><span class="token punctuation">,</span><span class="token string">'密码长度必须大于6'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>min<span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token function">validateLoginType</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> type <span class="token operator">=</span> params<span class="token punctuation">.</span>body<span class="token punctuation">.</span>loginType
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'请传入登录方式'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>global<span class="token punctuation">.</span>config<span class="token punctuation">.</span>LoginType<span class="token punctuation">.</span><span class="token function">isInType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'type参数不合法 '</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>Loginvalidator<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>isOptional 参数可以传可以不传</p></blockquote> <p>当参数通过校验器时, 定义方法判断传入的参数是否在数据库中存在</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">emailLogin</span> <span class="token punctuation">(</span><span class="token parameter">account<span class="token punctuation">,</span>secret</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">vertifyEmail</span><span class="token punctuation">(</span>account<span class="token punctuation">,</span>secret<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>一般情况下 校验传入的参数是否在数据库中,在模型中完成</p></blockquote> <p>user.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span><span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">vertifyEmail</span><span class="token punctuation">(</span><span class="token parameter">account<span class="token punctuation">,</span>secret</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            where<span class="token operator">:</span><span class="token punctuation">{</span>
                email<span class="token operator">:</span>account
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> 没有此账户的错误异常
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断密码是否和不加密前的密码相同</span>
        <span class="token keyword">const</span> corret <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>secret<span class="token punctuation">,</span>User<span class="token punctuation">.</span>password<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>corret<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> 密码错误异常
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> user
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>模型定义完之后</p> <h3 id="书写路由"><a href="#书写路由" class="header-anchor">#</a> 书写路由</h3> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/token'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Loginvalidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token keyword">const</span> type <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'body.loginType'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> account <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'body.account'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> secret <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'body.secret'</span><span class="token punctuation">)</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">case</span> LoginType<span class="token punctuation">.</span><span class="token constant">USER_EMAIL</span><span class="token operator">:</span>
            <span class="token comment">// 检验密码</span>
            <span class="token keyword">await</span> <span class="token function">emailLogin</span><span class="token punctuation">(</span>account<span class="token punctuation">,</span>secret<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 暂时返回token</span>
    ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token punctuation">{</span>
        token
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="微信登录接口"><a href="#微信登录接口" class="header-anchor">#</a> 微信登录接口</h3> <p>首先定义好需要的三个参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">URL</span>
appId
appSecret
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">wxManager</span><span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">openidTotoken</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 拼接url</span>
        <span class="token keyword">const</span> url <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">,</span>appId<span class="token punctuation">,</span>appSecret<span class="token punctuation">,</span>code<span class="token punctuation">)</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>status<span class="token operator">!==</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">getOpenIDException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>errcode<span class="token operator">!==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">getOpenIDException</span><span class="token punctuation">(</span><span class="token string">'获取openID失败'</span><span class="token operator">+</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>errcode<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 成功后 查询数据库 然后插入数据库 再获取token</span>
        <span class="token keyword">let</span> user <span class="token operator">=</span> User<span class="token punctuation">.</span><span class="token function">getOpenIdUser</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>openid<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span><span class="token punctuation">{</span>
           user <span class="token operator">=</span> User<span class="token punctuation">.</span><span class="token function">registerOpenId</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>openid<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>Auth<span class="token punctuation">.</span><span class="token constant">USER</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><strong>util.forma</strong>t Node.js提供的util的API,可以将第一个参数中的占位符换成后面的参数</p> <p><strong>getOpenIdUser</strong>   Model层中定义的静态方法 查询user</p> <p><strong>registerOpenId</strong>  插入openid</p> <p>Auth.USER  提前定义在Auth 获取令牌的class中的，表示权限的值 用户  只需要判断scope和传入的level值（当传入的level小于用户级别的scope时就可以获取token,反之就不可以）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Auth</span> <span class="token punctuation">{</span>
<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">level</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>level <span class="token operator">=</span> level <span class="token operator">||</span> <span class="token number">1</span>
    Auth<span class="token punctuation">.</span><span class="token constant">USER</span> <span class="token operator">=</span> <span class="token number">8</span>
    Auth<span class="token punctuation">.</span><span class="token constant">ADMIN</span> <span class="token operator">=</span> <span class="token number">16</span>
    Auth<span class="token punctuation">.</span><span class="token constant">SUPER_ADMIN</span> <span class="token operator">=</span> <span class="token number">32</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></blockquote> <p><strong>书写完微信登录获取openid之后，可以书写一个校验拿到的token的方法</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">verifyToken</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
       jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> global<span class="token punctuation">.</span>config<span class="token punctuation">.</span>security<span class="token punctuation">.</span>secretKey<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>当前端从<code>Storage</code>里面拿出token,检验它的合法性，然后再继续走下去</p> <h3 id="颁布令牌-获取token"><a href="#颁布令牌-获取token" class="header-anchor">#</a> 颁布令牌,获取token</h3> <p>在获取<code>token</code>之前先了解<code>jwt</code>的主要API</p> <div class="language-js extra-class"><pre class="language-js"><code>jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 生成令牌  需要传入参数:1.传入自定义信息(后面可封装在auth里) 2.secretKey秘钥(用户自定义) 3.配置（失效时间）</span>

例<span class="token operator">:</span>jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>
   <span class="token punctuation">{</span>uid<span class="token punctuation">,</span>scope<span class="token punctuation">}</span><span class="token punctuation">,</span>secretKey<span class="token punctuation">,</span><span class="token punctuation">{</span>expiresIn<span class="token punctuation">}</span>
  <span class="token punctuation">)</span>


jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//校验令牌 如果token无效会抛出异常</span>
<span class="token comment">// 需要传入 token 秘钥 两个个参数  </span>
最好是放在<span class="token keyword">try</span> catch中捕获异常
</code></pre></div><ul><li><p>定义基本配置</p> <div class="language-js extra-class"><pre class="language-js"><code>security <span class="token operator">=</span> <span class="token punctuation">{</span>
    secretKey<span class="token operator">:</span><span class="token string">'abcdefg'</span><span class="token punctuation">,</span><span class="token comment">// 自定义</span>
    expiresIn<span class="token operator">:</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span> <span class="token comment">//令牌时效</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>书写颁发令牌方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">generateToken</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">uid<span class="token punctuation">,</span>scope</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> token<span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>uid<span class="token punctuation">,</span>scope<span class="token punctuation">}</span><span class="token punctuation">,</span>security<span class="token punctuation">.</span>secretKey<span class="token punctuation">,</span><span class="token punctuation">{</span>expiresIn<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> token
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>登录时获取token</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">emailLogin</span><span class="token punctuation">(</span><span class="token parameter">account<span class="token punctuation">,</span>secret</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// user 登录时获</span>

    
    
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> token
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">vertifyEmail</span><span class="token punctuation">(</span><span class="token parameter">account<span class="token punctuation">,</span> secret</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    where<span class="token operator">:</span> <span class="token punctuation">{</span>
      email<span class="token operator">:</span> account
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LoginExecption</span><span class="token punctuation">(</span><span class="token string">'账号不存在'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>secret<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LoginExecption</span><span class="token punctuation">(</span><span class="token string">'密码输入错误'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> user
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="路由携带令牌校验"><a href="#路由携带令牌校验" class="header-anchor">#</a> 路由携带令牌校验</h2> <p>想清楚三件事:</p> <ol><li>token约定放在<code>header</code>还是<code>body</code>中</li> <li>用什么方式来检验token是否合法</li> <li>校验令牌中间件放在什么位置</li></ol> <blockquote><p>具体思路：首先一般情况下token在HTTPBasicAuth规则中是放在header部分的，然后我们通过这种方式测试</p> <p>校验合法性，书写中间价时调用 <code>jwt.verify()</code>来检验合法token</p> <p>校验令牌必须放在路由中间件前面,因为是最高权重 只有放了权限才能进行后面</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> baseAuth <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'base-auth'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Auth</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token comment">// 获取basicAuth的token值  而且这里必须用原生API req</span>
            <span class="token keyword">const</span> UserToken <span class="token operator">=</span> <span class="token function">baseAuth</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>USerToken <span class="token operator">||</span> <span class="token operator">!</span>UserToken<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">token</span>异常
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
                <span class="token keyword">var</span> decode <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>UserToken<span class="token punctuation">,</span>secretKey<span class="token punctuation">)</span>
                <span class="token comment">// 校验令牌合法 不合法抛出异常</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'TokenExpiredError'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          errMsg <span class="token operator">=</span> <span class="token string">'token令牌已经过期'</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ForbidenException</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>auth <span class="token operator">=</span> <span class="token punctuation">{</span>
            uid<span class="token operator">:</span>decode<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
            scope<span class="token operator">:</span>decode<span class="token punctuation">.</span>scope
        <span class="token punctuation">}</span>
        <span class="token comment">// 下一个中间件执行</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>new Auth().m  这里 m并不是方法 是class里面属性 通过get获取  实则是个中间件函数</p></blockquote> <p>校验完令牌之后,在router.get('') 中间注册中间件 <code>new Auth().m</code></p> <h2 id="前端携带令牌-basicauth方式-api-key方式"><a href="#前端携带令牌-basicauth方式-api-key方式" class="header-anchor">#</a> 前端携带令牌(BasicAuth方式)  (API key方式)</h2> <p>在发送HTTP请求时，加入这样的header</p> <div class="language-js extra-class"><pre class="language-js"><code>header<span class="token operator">:</span><span class="token punctuation">{</span>
    Authorization<span class="token operator">:</span>Basic <span class="token function">base64</span><span class="token punctuation">(</span>account<span class="token operator">:</span>password<span class="token punctuation">)</span> <span class="token comment">//必须 是base64加密后的token信息</span>
<span class="token punctuation">}</span>

<span class="token comment">// base64基本用法</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Base64<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'base64-js'</span>
<span class="token keyword">const</span> base64 <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>token<span class="token operator">+</span><span class="token string">':'</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token string">'Basic'</span><span class="token operator">+</span>base64
</code></pre></div><p>此时携带的令牌数据就可以传递</p> <div class="language-js extra-class"><pre class="language-js"><code>header<span class="token operator">:</span><span class="token punctuation">{</span>
    Authorization<span class="token operator">:</span>封装的函数
<span class="token punctuation">}</span>
</code></pre></div><p>使用API key方式就不需要base64加密处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 拿到约定好放在header或者query的token</span>
<span class="token keyword">class</span> <span class="token class-name">Auth</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> UserToken <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header<span class="token punctuation">.</span>token
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>USerToken<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">token</span>不合法异常
            <span class="token punctuation">}</span>
            <span class="token comment">// 校验token合法性</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
                <span class="token keyword">var</span> decode <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>UserToken<span class="token punctuation">,</span>global<span class="token punctuation">.</span>config<span class="token punctuation">.</span>secretKey<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>name <span class="token operator">=</span><span class="token string">'TokenExpiredError'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'令牌过期'</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">token</span>不合法
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>前端调用:</p> <div class="language-js extra-class"><pre class="language-js"><code>wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
    method<span class="token operator">:</span><span class="token string">'POST'</span><span class="token punctuation">,</span>
    header<span class="token operator">:</span><span class="token punctuation">{</span>
        token<span class="token operator">:</span>wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="具体业务"><a href="#具体业务" class="header-anchor">#</a> 具体业务</h2> <p>首先先把数据表的概念分清</p> <ul><li><p>业务表  ： 解决业务问题 抽象出来的，记录业务 比如说:一期又一期的期刊，存放他们不同的index来区分期刊</p></li> <li><p>实体表 ：具体到某个模型的数据，各种字段</p> <p>sequelize操控数据库具体参考<a href="https://itbilu.com/nodejs/npm/V1PExztfb.html#api" target="_blank" rel="noopener noreferrer">地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>模型层：分出 classic art flow user favor</p> <p>定义模型层</p> <blockquote><p>引入sequelize实例</p> <p>定义字段</p> <p>导出模型</p></blockquote> <blockquote><p>classic: 分为 movie sentence music  共同字段定义</p> <p>art ：所有的实体,所有期刊  由几个模型拼凑</p> <p>flow: 业务模型 应有的字段:<code>art_id</code>,<code>index</code>,<code>type</code>  对取出实体模型记录非常重要</p> <p>user: 用户模型</p> <p>favor</p></blockquote></li></ul> <h2 id="获取最新一期期刊"><a href="#获取最新一期期刊" class="header-anchor">#</a> 获取最新一期期刊</h2> <p>获取最新一期,就是拿出期刊号最大的那一个实体。</p> <blockquote><p>fow表降序取出第一条记录</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/latest'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
   <span class="token keyword">let</span> latest <span class="token operator">=</span> <span class="token keyword">async</span> folw<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
       <span class="token comment">// sequlize排序 写法 升序 ASC</span>
       order<span class="token operator">:</span><span class="token punctuation">[</span>
           <span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">,</span><span class="token string">'DESC'</span><span class="token punctuation">]</span>
       <span class="token punctuation">]</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token keyword">let</span> art <span class="token operator">=</span> <span class="token keyword">async</span> Art<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>latest<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
   art<span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span>latest<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> art
  
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>前端请求数据之前需要携带令牌,</p> <p>Art模型中定义查找记录方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Art</span> <span class="token punctuation">{</span>
    <span class="token comment">// 传入art_id 和 type</span>
 <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getOne</span><span class="token punctuation">(</span><span class="token parameter">art_id<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> find <span class="token operator">=</span> <span class="token punctuation">{</span>
      where<span class="token operator">:</span> <span class="token punctuation">{</span>
        id<span class="token operator">:</span> art_id
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">100</span><span class="token operator">:</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> movie<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>find<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token number">200</span><span class="token operator">:</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> music<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>find<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token number">300</span><span class="token operator">:</span>
        result <span class="token operator">=</span><span class="token keyword">await</span> sentence<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>find<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token number">400</span><span class="token operator">:</span>
        <span class="token keyword">break</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="点赞-取消点赞"><a href="#点赞-取消点赞" class="header-anchor">#</a> 点赞 取消点赞</h2> <blockquote><p>首先确定业务，<strong>点赞和取消点赞需要操作两张表</strong>，一张表记录用户点赞的记录，另一张实体表里面的收藏数量就会增加，或者减少</p></blockquote> <ul><li>对业务表添加记录或者删除记录</li> <li>修改实体表的数据</li></ul> <p>保证两个操作都能同时进行，可以使用数据库的<code>事物</code></p> <p>sequelize操作数据库的事物</p> <div class="language-js extra-class"><pre class="language-js"><code>sequelize<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 首先获取Favor中是否该用户点过赞 然后如果没有点赞向数据库添加一条记录 并且增加art实体的fav_nums</span>

<span class="token keyword">const</span> favor <span class="token operator">=</span><span class="token keyword">await</span> Favor<span class="token punctuation">.</span><span class="token function">finOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    where<span class="token operator">:</span><span class="token punctuation">{</span>
        uid<span class="token punctuation">,</span>art_id<span class="token punctuation">,</span>type
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>favor<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LikeException</span><span class="token punctuation">(</span><span class="token string">'已经点过赞'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 事务一定要用return的方式执行</span>
<span class="token keyword">return</span> sequelize<span class="token punctuation">.</span><span class="token function">trancation</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">t</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">await</span> Favor<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        art_id<span class="token punctuation">,</span>
        type<span class="token punctuation">,</span>
        uid
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>transcation <span class="token operator">:</span> t<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> art <span class="token operator">=</span><span class="token keyword">await</span> Art<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>art_id<span class="token punctuation">,</span>type<span class="token punctuation">)</span>
    <span class="token comment">// 自增涨一个字段 by 增长值</span>
    <span class="token keyword">await</span> art<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">'fav_nums'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>by<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>transaction<span class="token operator">:</span>t<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// dislike 同理 </span>
软删除 增加一条deleted_at
MOdel<span class="token punctuation">.</span>class<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span>force<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>transcation<span class="token operator">:</span>t<span class="token punctuation">)</span>
</code></pre></div><h2 id="上一期-下一期"><a href="#上一期-下一期" class="header-anchor">#</a> 上一期 下一期</h2> <blockquote><p>首先查找flow表中index的记录，然后index+1 ，增加异常判断，查询出art表的记录，并田间like_status和index</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:index/next'</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 校验 获取art_id type 获取实例 然后增加属性</span>
 <span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">IndexValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
 <span class="token keyword">const</span> index <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'path.index'</span><span class="token punctuation">)</span>
 <span class="token keyword">const</span> next <span class="token operator">=</span> <span class="token keyword">await</span> flow<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   where<span class="token operator">:</span><span class="token punctuation">{</span>
     index<span class="token operator">:</span>index <span class="token operator">+</span> <span class="token number">1</span>  
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token string">'没有下一期了'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">let</span> art <span class="token operator">=</span> <span class="token keyword">await</span> Art<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>art_id<span class="token punctuation">,</span>next<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
 <span class="token keyword">const</span> like_status <span class="token operator">=</span> <span class="token keyword">await</span> Favor<span class="token punctuation">.</span><span class="token function">Userlike</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>next<span class="token punctuation">.</span>art_id<span class="token punctuation">,</span>next<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
 art<span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span>next<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
 art<span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'like_status'</span><span class="token punctuation">,</span>like_status<span class="token punctuation">)</span>
 ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> art
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="获取点赞信息"><a href="#获取点赞信息" class="header-anchor">#</a> 获取点赞信息</h2> <blockquote><p>传入uid, art_id和type对favor表进行记录查询，返回布尔值</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">Userlike</span><span class="token punctuation">(</span><span class="token parameter">uid<span class="token punctuation">,</span> art_id<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回用户是否喜欢这个art</span>
    <span class="token keyword">const</span> favor <span class="token operator">=</span> <span class="token keyword">await</span> Favor<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token operator">:</span> <span class="token punctuation">{</span>
        uid<span class="token punctuation">,</span>
        art_id<span class="token punctuation">,</span>
        type<span class="token operator">:</span>type
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果存在点赞 就返回true</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>favor
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="获取某一期的详情信息"><a href="#获取某一期的详情信息" class="header-anchor">#</a> 获取某一期的详情信息</h2> <blockquote><p>传入type和art_id查找flow的记录 找到后查找like_status和index</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:type/:id/detail'</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">ClassicValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
  <span class="token keyword">const</span> art_id <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'path.id'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'path.type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> classic <span class="token operator">=</span> <span class="token keyword">await</span> flow<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'bh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    where<span class="token operator">:</span><span class="token punctuation">{</span>
      art_id<span class="token punctuation">,</span>
      type<span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>not<span class="token punctuation">]</span><span class="token operator">:</span><span class="token number">400</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>classic<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token string">'找不到该资源'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> art <span class="token operator">=</span> <span class="token keyword">await</span> Art<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>art_id<span class="token punctuation">,</span>type<span class="token punctuation">)</span>
  <span class="token keyword">const</span> like_status <span class="token operator">=</span> <span class="token keyword">await</span> Favor<span class="token punctuation">.</span><span class="token function">Userlike</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>art_id<span class="token punctuation">,</span>type<span class="token punctuation">)</span>
  art<span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span>classic<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
  art<span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'like_status'</span><span class="token punctuation">,</span>like_status<span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
    art
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="获取用户喜欢期刊列表"><a href="#获取用户喜欢期刊列表" class="header-anchor">#</a> 获取用户喜欢期刊列表</h2> <blockquote><p>传入uid查询favor表得到一个数组，然后Art模型编写获取列表方法</p> <p>定义一个对象 注意json的key永远都是字符串</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> artInfoObj <span class="token operator">=</span><span class="token punctuation">{</span>
	<span class="token number">100</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token number">200</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token number">300</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>获取列表元素 for循环 artInfoList</p> <p><code>artInfoObj[artinfo.type].push(artinfo.art_id)</code></p> <p>再循环对象 查找type下的数组列表</p> <p>ids artInfoObj[key]</p> <p>type key</p> <p>如果是空数组 跳出循环</p> <p>for循环不需要定义大量的复杂逻辑,封装一个函数</p> <p>注意：obj的key是字符串  传参会报错</p> <p>循环引用会报undefined  解决方法：局部导入</p> <p>最终结果需要将所有的数组提取到大数组  [[],[],[]]</p> <p>使用<code>faltten</code>方法</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getFavorList</span><span class="token punctuation">(</span><span class="token parameter">list<span class="token punctuation">,</span>uid</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 最终返回结果 [[100:],[200:],[300:]]</span>
    <span class="token keyword">let</span> FavorListObj <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token number">100</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token number">200</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token number">300</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 分别向不同的type中添加 ids  现在的obj {100:[1,2,3],200:[1,2,3]..}</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      FavorListObj<span class="token punctuation">[</span>item<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>art_id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">in</span> FavorListObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 拿到每个key :item-type  拿到每个key下的ids FavorListobj[item]</span>
      <span class="token comment">//进行in查询</span>
      <span class="token keyword">let</span> itemX <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>FavorListObj<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span>
      <span class="token punctuation">}</span>
      ret<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">await</span> Favor<span class="token punctuation">.</span><span class="token function">_getlistByType</span><span class="token punctuation">(</span>itemX<span class="token punctuation">,</span> FavorListObj<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">,</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 需要借助loadsh 打散二维数组为一维数组</span>
    <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">_getlistByType</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> ids<span class="token punctuation">,</span>uid</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> find <span class="token operator">=</span> <span class="token punctuation">{</span>
      where<span class="token operator">:</span> <span class="token punctuation">{</span>
        id<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>in<span class="token punctuation">]</span><span class="token operator">:</span> ids
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">100</span><span class="token operator">:</span>
        result<span class="token operator">=</span> <span class="token keyword">await</span> movie<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'bh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>find<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token number">200</span><span class="token operator">:</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> music<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'bh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>find<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token number">300</span><span class="token operator">:</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> sentence<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'bh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>find<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// result 返回实体数组 [[],[],[]]</span>
    result<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> like_status <span class="token operator">=</span><span class="token keyword">await</span> Favor<span class="token punctuation">.</span><span class="token function">Userlike</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span>item<span class="token punctuation">.</span>id<span class="token punctuation">,</span>item<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
      item<span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'like_status'</span><span class="token punctuation">,</span>like_status<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="获取热门图书"><a href="#获取热门图书" class="header-anchor">#</a> 获取热门图书</h2> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getHotBooklist</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 获取所有的art_id</span>
    <span class="token keyword">let</span> ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">book</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      ids<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> favors<span class="token operator">=</span>  <span class="token keyword">await</span> Favor<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'bh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      art_id<span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>in<span class="token punctuation">]</span><span class="token operator">:</span>ids
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span><span class="token number">400</span><span class="token punctuation">,</span>
    group<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'art_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 分组结果 [{art_id:1,count:},{}....]</span>
    attributes<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'art_id'</span><span class="token punctuation">,</span><span class="token punctuation">[</span>Sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'COUNT'</span><span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'count'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 循环遍历所有的图书</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">book</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      Hotbook<span class="token punctuation">.</span><span class="token function">_setCount</span><span class="token punctuation">(</span>book<span class="token punctuation">,</span>favors<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> list
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果存在favor表中就把 count赋给book</span>
  <span class="token keyword">static</span> <span class="token function">_setCount</span><span class="token punctuation">(</span><span class="token parameter">book<span class="token punctuation">,</span>favors</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
    favors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">favor</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>id <span class="token operator">===</span> favor<span class="token punctuation">.</span>art_id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        count <span class="token operator">=</span> favor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    book<span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span>
    <span class="token keyword">return</span> book
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="评论"><a href="#评论" class="header-anchor">#</a> 评论</h2> <p>定义book模型 id fav_nums</p> <p>从服务器请求数据 返回详情</p> <p>图书搜索</p> <p>定义校验器  三个参数 query ：keyword，start count</p> <p>start 可传可不传  传一个默认值  summary=1 鱼书搜索不返回概要信息</p> <p>encodeURI(q)  将可能为中文的编码转换</p> <h2 id="json序列化"><a href="#json序列化" class="header-anchor">#</a> json序列化</h2> <p>再返回的字段中定义<code>toJSON</code>方法指定返回的字段，sequelize就定义在模型中 实例方法。</p> <p><code>this.getDataValue()</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        content<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataValue</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://image.yangxiansheng.top/img/QQ%E6%88%AA%E5%9B%BE20200329204854.png?imagelist" alt=""></p> <p>原型链方法定义Model方法 删除dataValues的某些字段</p> <h2 id="koa-static"><a href="#koa-static" class="header-anchor">#</a> KOA-STATIC</h2> <p>处理静态资源  __dirname 项目目录</p> <div class="language-js extra-class"><pre class="language-js"><code>访问<span class="token operator">/</span><span class="token keyword">static</span>文件夹
<span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'/static'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 这样localhost路径 就可以访问到static文件夹下的文件</span>

添加配置<span class="token operator">:</span>host<span class="token operator">:</span><span class="token string">'http://localhost:3000/'</span>
</code></pre></div><p><img src="https://image.yangxiansheng.top/img/QQ%E6%88%AA%E5%9B%BE20200329221551.png?imagelist" alt=""></p> <p>art模型替换image路径</p> <h2 id="自动无感知刷新令牌"><a href="#自动无感知刷新令牌" class="header-anchor">#</a> 自动无感知刷新令牌</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">_request</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> noRefetch <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      url<span class="token operator">:</span> api<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      method<span class="token operator">:</span> method<span class="token punctuation">,</span>
      data<span class="token operator">:</span> data<span class="token punctuation">,</span>
      header<span class="token operator">:</span> <span class="token punctuation">{</span>
        Authorization<span class="token operator">:</span> wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> code <span class="token operator">=</span> res<span class="token punctuation">.</span>statusCode
          <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">403</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>noRefetch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">_refetch</span><span class="token punctuation">(</span>
                url<span class="token punctuation">,</span>
                resolve<span class="token punctuation">,</span>
                reject<span class="token punctuation">,</span>
                data<span class="token punctuation">,</span>
                method
              <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">_refetch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">getTokenFromServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_request</span><span class="token punctuation">(</span><span class="token operator">...</span>param<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last update:</span> <span class="time">3/30/2020, 10:13:07 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/webpack/test.html" class="prev">
        webpack 4.0 学习
      </a></span> <span class="next"><a href="/guide/node/springboot.html">
        Springboot
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.81dd3622.js" defer></script><script src="/assets/js/2.d1b1e148.js" defer></script><script src="/assets/js/27.2938dd4c.js" defer></script><script src="/assets/js/4.a3faee54.js" defer></script>
  </body>
</html>
